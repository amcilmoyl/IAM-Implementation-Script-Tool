<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdButler Implementation Toolkit</title>
    <!-- Load Poppins from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* BRAND GUIDELINES */
        :root {
            --brand-yellow: #F9DC6B;
            --brand-navy: #252535;
            --brand-light-gray: #EEF3F7;
            --brand-teal: #028072;
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--brand-light-gray); /* #EEF3F7 */
        }
        
        /* Ensures high contrast for all main text */
        .text-brand-navy { color: var(--brand-navy); }
        .bg-brand-navy { background-color: var(--brand-navy); }

        /* Style for the 'Advertisement' label (low contrast, used for subtle disclosure) */
        .ad-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #6b7280; /* Gray-500, ensures readability but remains subtle */
            margin-bottom: 0.25rem;
            font-weight: 600;
        }

        /* Styling for the responsive wrapper (uses light brand colors) */
        .responsive-ad-wrapper {
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
            padding: 1rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem;
            background-color: #f9fafb; /* Off-white for readability */
        }

        /* Primary Button Style (Teal background with white text for high contrast) */
        .btn-primary {
            background-color: var(--brand-teal); 
            color: white;
            transition: background-color 0.2s;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #016a5c; /* Slightly darker teal on hover */
        }
        .btn-primary:disabled {
            opacity: 0.5;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 md:p-10">
        <h1 class="text-3xl font-bold text-brand-navy mb-2">Implementation Tag Builder</h1>
        <p class="text-gray-600 mb-6">Enter the Publisher ID to fetch, modify, and collect all website and email zone tags.</p>

        <!-- Input and Action Controls -->
        <div class="flex flex-col md:flex-row gap-4 mb-8 p-4 rounded-lg border border-brand-light-gray" style="background-color: var(--brand-light-gray);">
            <input type="text" id="publisherId" placeholder="Enter AdButler Publisher ID (e.g., 123456)"
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-brand-teal focus:border-brand-teal shadow-sm text-brand-navy">
            <button id="fetchButton"
                    class="btn-primary font-semibold py-3 px-6 rounded-lg shadow-md">
                Fetch & Process Tags
            </button>
        </div>

        <!-- Status and Loading Indicator -->
        <p id="statusMessage" class="text-sm text-red-600 mb-4 h-5"></p>

        <!-- Results Section -->
        <div id="resultsContainer" class="space-y-10 hidden">

            <!-- Website Tags Section -->
            <div>
                <h2 class="text-2xl font-semibold text-brand-navy mb-4 flex items-center">
                    Website Ad Zones (Header Script Assumed)
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" style="color: var(--brand-teal);" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                </h2>
                <p class="text-sm text-gray-500 mb-4">
                    The tags below are modified:
                    <ul class="list-disc list-inside ml-4">
                        <li>The main AdButler JS library call is REMOVED (assumes it's in the website header).</li>
                        <li>Wrapped for responsiveness and includes the "Advertisement" label.</li>
                    </ul>
                </p>
                <div id="websiteTagsOutput" class="space-y-6">
                    <!-- Website tags will be injected here -->
                </div>
                <button onclick="copyAllTags('websiteTagsOutput')" class="mt-4 text-sm font-medium hover:text-brand-teal transition duration-150" style="color: var(--brand-teal);">
                    Copy All Website Tags
                </button>
            </div>

            <hr class="border-gray-300">

            <!-- Email Tags Section -->
            <div>
                <h2 class="text-2xl font-semibold text-brand-navy mb-4 flex items-center">
                    Email Newsletter Zones (EUID Placeholder Added)
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 ml-2" style="color: var(--brand-yellow);" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"/>
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"/>
                    </svg>
                </h2>
                <p class="text-sm text-gray-500 mb-4">
                    The tags below include the necessary **`[EUID_PLACEHOLDER]`** which you must replace with the email platform's unique user identifier variable (e.g., ActiveCampaign's `%CONTACTID%` or Cakemail's equivalent).
                </p>
                <div id="emailTagsOutput" class="space-y-6">
                    <!-- Email tags will be injected here -->
                </div>
                <button onclick="copyAllTags('emailTagsOutput')" class="mt-4 text-sm font-medium hover:text-brand-teal transition duration-150" style="color: var(--brand-teal);">
                    Copy All Email Tags
                </button>
            </div>
        </div>

    </div>

    <script>
        const API_KEY = ""; // Replace with your actual AdButler API key or token
        const API_ENDPOINT = 'https://api.adbutler.com/v1/zones'; // Replace with your actual API endpoint

        const fetchButton = document.getElementById('fetchButton');
        const publisherIdInput = document.getElementById('publisherId');
        const statusMessage = document.getElementById('statusMessage');
        const resultsContainer = document.getElementById('resultsContainer');
        const websiteTagsOutput = document.getElementById('websiteTagsOutput');
        const emailTagsOutput = document.getElementById('emailTagsOutput');
        
        // Helper function for exponential backoff retry logic
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status === 429 && i < retries - 1) { // Too Many Requests
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    // Exponential backoff delay happens in the try block
                }
            }
        }

        /**
         * Simulates fetching data from the AdButler API.
         * REPLACE THIS FUNCTION with your actual authenticated API call logic.
         */
        async function fetchAdButlerZones(publisherId) {
            // --- MOCK DATA FOR DEMONSTRATION ---
            statusMessage.textContent = 'Simulating API call and processing zones...';
            await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network latency

            const mockZones = [
                { id: 123, name: "Homepage Leaderboard", type: "website", width: 728, height: 90 },
                { id: 124, name: "Article Sidebar (300x250)", type: "website", width: 300, height: 250 },
                { id: 125, name: "In-Content Unit", type: "website", width: 600, height: 300 },
                { id: 401, name: "Newsletter Top Banner", type: "email", width: 600, height: 90 },
                { id: 402, name: "Newsletter Bottom Rectangle", type: "email", width: 300, height: 250 },
            ];

            return mockZones.map(zone => {
                const rawTag = zone.type === 'website' 
                    ? `<!-- AdButler Zone ${zone.id}: ${zone.name} -->
<div id="adbutler-zone-${zone.id}"></div>
<script type="text/javascript" src="https://servedbyadbutler.com/app.js"></script>
<script type="text/javascript">
    adbutler.optimize.fetch({
        zone: ${zone.id},
        width: ${zone.width},
        height: ${zone.height},
        type: 'async'
    });
</script>`
                    : `<!-- AdButler Email Zone ${zone.id}: ${zone.name} -->
<a href="https://servedbyadbutler.com/cl.srv?sid=12345&pub=99999&zone=${zone.id}&pid=0&ord=[EUID_PLACEHOLDER]" target="_blank" rel="noopener">
    <img src="https://servedbyadbutler.com/ad.srv?sid=12345&pub=99999&zone=${zone.id}&pid=0&ord=[EUID_PLACEHOLDER]" alt="${zone.name}" border="0" width="${zone.width}" height="${zone.height}">
</a>`;
                
                return {
                    ...zone,
                    rawTag: rawTag
                };
            });
        }

        /**
         * Cleans and wraps the website ad zone tag as requested.
         */
        function processWebsiteTag(zone) {
            let processedTag = zone.rawTag;

            // 1. Remove the JS library call
            const jsLibRegex = /<script\s+[^>]*src=["']https:\/\/servedbyadbutler\.com\/app\.js["'][^>]*><\/script>/gi;
            processedTag = processedTag.replace(jsLibRegex, '');

            // 2. Add wrapper for responsiveness and 'Advertisement' label
            const indentedProcessedTag = processedTag.trim().split('\n').map(line => '        ' + line).join('\n');

            const wrappedTag = 
                `<div class="responsive-ad-wrapper">
    <!-- Zone: ${zone.name} (${zone.width}x${zone.height}) -->
    <div class="ad-label">Advertisement</div>
    <div class="adbutler-container-${zone.id}">
${indentedProcessedTag}
    </div>
</div>`.trim();

            return wrappedTag;
        }

        /**
         * Modifies the email tag to include the EUID placeholder.
         */
        function processEmailTag(zone) {
            let processedTag = zone.rawTag;
            
            processedTag = processedTag.replace(/ord=([^&\s"]+)/g, 'ord=[EUID_PLACEHOLDER]');

            return processedTag;
        }

        /**
         * Renders the processed tags to the UI.
         */
        function renderTags(zones) {
            websiteTagsOutput.innerHTML = '';
            emailTagsOutput.innerHTML = '';
            
            const websiteZones = zones.filter(z => z.type === 'website');
            const emailZones = zones.filter(z => z.type === 'email');

            // Render Website Tags
            websiteZones.forEach(zone => {
                const processedTag = processWebsiteTag(zone);
                
                websiteTagsOutput.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-brand-navy mb-2">${zone.name} (Zone ID: ${zone.id})</h4>
                        <textarea readonly class="w-full h-64 p-3 text-sm font-mono bg-gray-50 border border-gray-300 rounded-lg whitespace-pre-wrap">${processedTag}</textarea>
                    </div>
                `;
            });

            // Render Email Tags
            emailZones.forEach(zone => {
                const processedTag = processEmailTag(zone);
                emailTagsOutput.innerHTML += `
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h4 class="font-bold text-brand-navy mb-2">${zone.name} (Zone ID: ${zone.id})</h4>
                        <textarea readonly class="w-full h-40 p-3 text-sm font-mono bg-gray-50 border border-gray-300 rounded-lg whitespace-pre-wrap">${processedTag}</textarea>
                    </div>
                `;
            });

            if (websiteZones.length === 0 && emailZones.length === 0) {
                statusMessage.textContent = 'No zones found for this Publisher ID.';
                resultsContainer.classList.add('hidden');
            } else {
                statusMessage.textContent = `Successfully processed ${zones.length} zones.`; 
                statusMessage.classList.remove('text-red-600', 'text-blue-500');
                statusMessage.classList.add('text-brand-navy'); // Use brand navy for success/status text
                resultsContainer.classList.remove('hidden');
            }
        }
        
        /**
         * Copies all tags from a container (textarea content only).
         */
        function copyAllTags(containerId) {
            const container = document.getElementById(containerId);
            const textareas = container.querySelectorAll('textarea');
            let allText = '';
            textareas.forEach(textarea => {
                allText += textarea.value + '\n\n' + '<!-- --- SEPARATOR --- -->' + '\n\n';
            });

            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = allText.trim();
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                alertBox.show('Success!', 'All tags copied to clipboard.', 'bg-brand-teal');
            } catch (err) {
                alertBox.show('Error', 'Could not copy text. Please select and copy manually.', 'bg-red-500');
                console.error('Copy failed:', err);
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }

        // Custom non-blocking Alert Box implementation
        const alertBox = {
            element: null,
            init() {
                if (this.element) return; 
                this.element = document.createElement('div');
                this.element.id = 'custom-alert';
                this.element.className = `fixed top-4 right-4 p-4 rounded-lg text-white shadow-lg transition-transform duration-300 transform translate-x-full z-50`;
                document.body.appendChild(this.element);
            },
            show(title, message, bgColor) {
                this.init();
                this.element.className = `fixed top-4 right-4 p-4 rounded-lg text-white shadow-lg transition-transform duration-300 transform translate-x-full z-50 ${bgColor}`;
                // FIX: Replacing template literal with string concatenation for maximum compatibility
                this.element.innerHTML = '<p class="font-bold">' + title + '</p><p class="text-sm">' + message + '</p>';
                
                // Show animation
                setTimeout(() => this.element.classList.remove('translate-x-full'), 10);
                
                // Hide animation
                setTimeout(() => this.element.classList.add('translate-x-full'), 3000);
            }
        };


        /**
         * Main event listener for the fetch button.
         */
        fetchButton.addEventListener('click', async () => {
            const publisherId = publisherIdInput.value.trim();
            if (!publisherId) {
                statusMessage.textContent = 'Please enter a Publisher ID.';
                return;
            }

            fetchButton.disabled = true;
            statusMessage.textContent = 'Fetching and processing tags...';
            statusMessage.classList.remove('text-red-600', 'text-green-600', 'text-brand-navy');
            statusMessage.classList.add('text-blue-500'); // Temp blue for loading
            resultsContainer.classList.add('hidden');
            
            try {
                const zones = await fetchAdButlerZones(publisherId);
                renderTags(zones);
            } catch (error) {
                console.error('Processing error:', error);
                statusMessage.textContent = `Error fetching data: ${error.message}. Check console for details.`;
                statusMessage.classList.remove('text-blue-500', 'text-green-600', 'text-brand-navy');
                statusMessage.classList.add('text-red-600');
                resultsContainer.classList.add('hidden');
            } finally {
                fetchButton.disabled = false;
            }
        });
        
        // Expose copy function globally for inline click event
        window.copyAllTags = copyAllTags;

    </script>
</body>
</html>
